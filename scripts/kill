#!/usr/bin/env bash

#set -e

ROOT_PATH="$(git rev-parse --show-toplevel)"
source ${ROOT_PATH}/scripts/_helper

kill_backend() {
  is_pid_in_project() {
    local pid="$1"
    if [[ -z "$pid" ]]; then
      return 1
    fi

    # Prefer /proc when available (Linux). Fallback to ps for limited environments.
    local cwd exe_file args
    cwd=$(readlink -f "/proc/$pid/cwd" 2>/dev/null || ps -p "$pid" -o cwd= 2>/dev/null | tr -d ' ')
    exe_file=$(readlink -f "/proc/$pid/exe" 2>/dev/null || echo "")
    args=$(ps -p "$pid" -o args= 2>/dev/null || echo "")

    # Strong signals the process belongs to THIS repo:
    # - CWD is inside repo root
    # - Executable is inside repo root (e.g. built binary under ROOT_PATH/bin)
    # - Command line contains the repo root (go run with absolute paths, etc.)
    if [[ -n "$cwd" && "$cwd" == "$ROOT_PATH"* ]]; then
      return 0
    fi
    if [[ -n "$exe_file" && "$exe_file" == "$ROOT_PATH"* ]]; then
      return 0
    fi
    if [[ -n "$args" && "$args" == *"$ROOT_PATH"* ]]; then
      return 0
    fi

    return 1
  }

  # First, try to find processes by name patterns
  arr_backend=("goSign" "__debug_bin" "cmd/goSign/main.go serve")
  for process_name in "${arr_backend[@]}"; do
    pids=$(pgrep -f "$process_name" 2>/dev/null)
    for pid in $pids; do
      if [ -z "$pid" ]; then
        continue
      fi
      if is_pid_in_project "$pid"; then
        print_header "Killed backend process ${pid}"
        kill -9 $pid 2>/dev/null
        print_answer "SUCCESS" green
      fi
    done
  done

  # Also check processes listening on backend port (8088)
  backend_port_pids=$(lsof -ti :8088 2>/dev/null)
  for pid in $backend_port_pids; do
    if [ -z "$pid" ]; then
      continue
    fi
    # Kill only if we can attribute the PID to THIS repo.
    if is_pid_in_project "$pid"; then
      print_header "Killed backend process ${pid} (port 8088)"
      kill -9 $pid 2>/dev/null
      print_answer "SUCCESS" green
      continue
    fi

    # Secondary heuristic: if the listener itself isn't attributable, but its parent
    # is a go-run process started from THIS repo, treat it as ours.
    ppid=$(ps -p $pid -o ppid= 2>/dev/null | tr -d ' ')
    parent_cmd=$(ps -p $ppid -o args= 2>/dev/null || echo "")
    parent_cwd=$(readlink -f /proc/$ppid/cwd 2>/dev/null || ps -p $ppid -o cwd= 2>/dev/null | tr -d ' ' || echo "")
    if [[ -n $parent_cmd && $parent_cmd == *"go run"* && ($parent_cmd == *"main.go serve"* || $parent_cmd == *"cmd/goSign"*) ]]; then
      if [[ -n $parent_cwd && ($parent_cwd == "$ROOT_PATH"* || $parent_cwd == "$ROOT_PATH/cmd/goSign"*) ]]; then
        print_header "Killed backend process ${pid} (port 8088)"
        kill -9 $pid 2>/dev/null
        print_answer "SUCCESS" green
      fi
    fi
  done
}

kill_frontend() {
  arr_frontend=("vite")
  for process_name in "${arr_frontend[@]}"; do
    pids=$(pgrep -f "$process_name" 2>/dev/null)
    for pid in $pids; do
      if [ -z "$pid" ]; then
        continue
      fi
      # Get current working directory of the process
      cwd=$(readlink -f /proc/$pid/cwd 2>/dev/null || ps -p $pid -o cwd= 2>/dev/null | tr -d ' ')
      if [[ -n $cwd && $cwd == "$ROOT_PATH/web"* ]]; then
        print_header "Killed frontend process ${pid}"
        kill -9 $pid 2>/dev/null
        print_answer "SUCCESS" green
      fi
    done
  done
}

TARGET=${1:-all}

case "$TARGET" in
backend)
  print_header "Killing backend processes"
  kill_backend
  ;;
frontend)
  print_header "Killing frontend processes"
  kill_frontend
  ;;
all)
  kill_backend
  kill_frontend
  ;;
*)
  print_answer "ERROR" red
  echo "Invalid parameter: $TARGET"
  echo
  echo "$0 [command]"
  echo
  echo "command:"
  print_help all "Kill all processes (default)"
  print_help backend "Kill backend processes only"
  print_help frontend "Kill frontend processes only"
  exit 1
  ;;
esac

